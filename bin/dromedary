#!/usr/bin/env ruby

# Before doing anything else, need to
# force bundler to load up so we
# can require gems from the Gemfile
#
require "pathname"
ENV["BUNDLE_GEMFILE"] ||= File.expand_path("../../Gemfile",
                                           Pathname.new(__FILE__).realpath)
require "rubygems"
require "bundler/setup"

# Add the local lib

$LOAD_PATH.unshift (Pathname(__dir__).parent + 'lib').to_s
$LOAD_PATH.unshift (Pathname(__dir__).parent + 'indexer').to_s

# Now we can actually load stuff
require 'hanami/cli'
require 'med_installer'

# Set this up as a CLI
module MedInstaller
  class CLI
    extend Hanami::CLI::Registry
  end
end


MedInstaller::CLI.register 'extract', MedInstaller::Extract, aliases: ['unzip']
MedInstaller::CLI.register 'convert', MedInstaller::Convert, aliases: ['json']
# MedInstaller::CLI.register 'index', MedInstaller::Index

MedInstaller::CLI.register 'index entries', MedInstaller::Index::Entries
MedInstaller::CLI.register 'index bib', MedInstaller::Index::Bib
MedInstaller::CLI.register 'index full', MedInstaller::Index::Full, aliases: ['all']


MedInstaller::CLI.register 'solr install', MedInstaller::Solr::Install
MedInstaller::CLI.register 'solr link', MedInstaller::Solr::Link
MedInstaller::CLI.register 'solr start', MedInstaller::Solr::Start, aliases: ['restart']
MedInstaller::CLI.register 'solr stop', MedInstaller::Solr::Stop
MedInstaller::CLI.register 'solr reload', MedInstaller::Solr::Reload
MedInstaller::CLI.register 'solr rebuild_suggesters', MedInstaller::Solr::RebuildSuggesters
MedInstaller::CLI.register 'solr empty', MedInstaller::Solr::Empty, aliases: ['clear']

Hanami::CLI.new(MedInstaller::CLI).call


__END__

zipfile = ARGV[0]
datadir = ARGV[1]

med = MedInstaller::Commands.new
med.checkargs(zipfile, datadir)

xmlpath = Pathname.new(datadir) + 'xml'
xmlpath.mkpath

$stderr.puts "Extracting all the xml files from #{zipfile}"
med.extract_all(zipfile, xmlpath)




